---
title: "Making Maps"
---

This is a brief overview on how to create custom choropleth maps in R using Shapefiles. Some basic knowledge of R is assumed.

<div style="text-align:left"><span style="color:black; font-family:Corbel; font-size:1.5em;">Step 1: Load the libraries</span></div>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(ggplot2) # Our favourite grammar of graphics to create the map
library(rgdal) # turning a shapefile into a dataframe
library(plyr) # for "join" function
```

<div style="text-align:left"><span style="color:black; font-family:Corbel; font-size:1.5em;">Step 2: Get your data</span></div>

You will need: </p>
a) The data you want to map </p>
b) A Shapefile (which is an amalgamation of several files containing geospatial data). See [here](https://doc.arcgis.com/en/arcgis-online/reference/shapefiles.htm) for more information about Shapefiles.
</br>
The aim of the game is to convert the Shapefile into a dataframe, and join with the data you wish to map. In order to do this, you will need to have a common variable (e.g. a Local Authority code)

In this example, we are going to use Active Lives Survey data from the Sport England Active Lives dataset (datasets available on the [UK Data Archive](https://beta.ukdataservice.ac.uk/datacatalogue/studies/#!?Search=active%20lives%20survey&Page=1&Rows=10&Sort=1&DateFrom=440&DateTo=2019)). This data goes down to a Local Authority level (England only). The entire dataset is available as an spss file, but I have converted the query output (Local Authority by Activity Level) to .csv.</p> 
We will use the Shapefile from [data.gov.uk](https://data.gov.uk/dataset/45a1aaed-503a-4259-bd3e-27ce2ddc7b16/local-authority-districts-december-2016-super-generalised-clipped-boundaries-in-the-uk). This contains data beyond our interest (i.e. beyond England) so we will need to do a bit of data cleaning once we have created our joined dataframe.

<div style="text-align:left"><span style="color:black; font-family:Corbel; font-size:1.5em;">Step 3: Read in your data</span></div>
We now read in our csv file of Active Lives data.
```{r}
df <- read.csv("input/Active_Lives_Data.csv", header = TRUE) # read in the file and keep the headers

df[1,c(1:6)] # cheeky peek at the first row and first few columns of data to check 

```

Use the **rgdal** package to read in the Shapefile. After it has been read in, joined with the Active Lives data, and converted to a dataframe,  we can remove extraneous data (anything not in England) by using *grep* (regular expression) function on the Local Authority code column (aka "lad17cd").
```{r echo=TRUE, message=FALSE, warning=FALSE}
setwd("input/Shapefile")
map <- readOGR(dsn = ".", layer = "Local_Authority_Districts_December_2017_Super_Generalised_Clipped_Boundaries_in_Great_Britain", verbose = FALSE)
#summary(map) # see if projections used if necessary
# head(map@data) # check read in

map@data$id <- rownames(map@data)
map@data   <- join(map@data, df, by="lad17cd") #join
map.df     <- fortify(map) #to dataframe
map.df     <- join(map.df,map@data, by="id")  #join

map.df <- map.df[grep("E", map.df$lad17cd),] # England only
map.df <- map.df[, !duplicated(colnames(map.df))] # remove dupe cols
```

We now have a dataframe that we can use with the (magnificent) ggplot2. Full disclosure, I heart ggplot2. Here is an excellent cheatsheet which I have found useful on many occasions:

<a href="https://github.com/rstudio/cheatsheets/blob/master/data-visualization-2.1.pdf"><img src="images/Screenshot.png"></a> 
</br>
</br>
<div style="text-align:left"><span style="color:black; font-family:Corbel; font-size:1.5em;">Step 4: ggplot!</span></div>
We can use *geom_polygon* to create our map, and strip out axes, gridlines etc. using  *theme*.

```{r echo=TRUE, fig.align='center', message=FALSE, warning=FALSE}
se_colour<- c("#bdd7e7", "#6baed6", "#3182bd", "#08519c") # custom colours to use in the chart

ggplot() +
  geom_polygon(data = map.df, aes(x = long, y = lat, group = group, fill = Total.Active.breaks))+
  theme_minimal() + 
  theme(axis.title.x = element_blank(),axis.title.y = element_blank(), 
        text = element_text(family = "Corbel", color = "#5F5F5F"), 
        plot.title=element_text(size=12,family = "Corbel", face="bold", hjust = 0.5),
        panel.grid = element_blank(), # remove all axes and gridlines
        axis.text = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "bottom") +
  labs(title = "Adults (16+) who are active (150 Minutes and over per week)\n by Local Authority", caption = "Sport England: Active Lives Survey 2017/2018") +
  scale_fill_manual(values = se_colour, name = "Active\n% Breaks")
```

